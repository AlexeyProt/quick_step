var tabsScript = new TemplateScript('/js/modules/Tabs.js');
function EditorTabs ( editor ) {
	this.editor = editor;
	this.containerId = 'tabsContainer';
	
	this.setContainerId();
	this.addTab();
}

EditorTabs.prototype.setContainerId = function () {
	for ( var i = 0; this.editor.dom.get(this.containerId); i++ ) {
		this.containerId = 'tabsContainer' + i;
	}
};

EditorTabs.prototype.createTabs = function ( tabs ) {
	var ul = document.createElement('ul'),	  
		li = document.createElement('li'),
		div = document.createElement('div'),
		tabsContainer = document.createElement('div'),
		tabsContent = [];
	tabsContainer.id = this.containerId;
	tabsContainer.className = "tabsContainer";
	ul.className = "tabs";
	for ( var i = 0; i < tabs.length; i++ ) {
		li = li.cloneNode(true);
		li.innerHTML = tabs[i].title;
		ul.appendChild(li);
		tabContent = div.cloneNode(true);
		tabContent.dataset.tab = tabs[i].title;
		tabsContent[tabsContent.length] = tabContent;
	}
	tabsContainer.appendChild(ul);
	for ( var i = 0; i < tabsContent.length; i++ ) {
		tabsContainer.appendChild(tabsContent[i]);
	}		
	return tabsContainer;	
};
// Устанавливает курсор в содержимое вкладки
// string tabTitle - название вкладки
EditorTabs.prototype.setCursorContentTab = function ( tabTitle ) {
	var contentTab = this.tabsContainer.querySelector( '[data-tab="'+tabTitle+'"]' );
	if ( contentTab.firstElementChild === null ) {
		contentTab.appendChild( document.createElement('p') );
	}		
	this.editor.selection.setCursorLocation( contentTab.firstElementChild );	
};

EditorTabs.prototype.select = function () {
	var self = this;
	this.tabsContainer.addEventListener('click', function () {
		console.log(self.tabsContainer);
		caretNode = self.editor.selection.getNode();
		if ( caretNode.dataset.status !== undefined && caretNode.dataset.status == 'active' ) {
			self.setCursorContentTab( caretNode.innerHTML );
		}	
	});	
	/* this.editor.selection.select( this.tabsContainer.querySelector() ); */
};

EditorTabs.prototype.addTab = function () {
	var self = this;
	// Add a button that opens a window
	this.editor.addButton('addTab', {
		text: 'Добавить вкладку',
		icon: false,
		onclick: function() {
			// Open window
			self.editor.windowManager.open({
				title: 'myplugin plugin',
				body: [
					{type: 'textbox', name: 'title', label: 'Title'}
				],
				onsubmit: function(e) {
					var tab = document.createElement('li'),
						tabs = self.tabsContainer.querySelector('.tabs'),
						tabContent = document.createElement('div');
					tab.innerHTML = e.data.title;
					tabContent.dataset.tab = e.data.title;
					tabs.appendChild(tab);
					self.tabsContainer.appendChild(tabContent);
				}
			});
		}
	});	
};

EditorTabs.prototype.setTabsContainer = function ( tabs ) {
	this.editor.selection.setNode( this.createTabs( tabs ) );
	this.tabsContainer = this.editor.dom.get( this.containerId );
	new Tabs( this.tabsContainer );
	this.select();
	this.setCursorContentTab( tabs[0].title );
	this.editor.addContextToolbar('#'+this.containerId, 'addTab');
};

function EditorsTabs () {
	
}

EditorsTabs.prototype.addEditorTab = function ( editorTab ) {
	this.setActiveEditorTab(editorTab);
	this.addEventSelect();
};

EditorsTabs.prototype.setActiveEditorTab = function ( editorTab ) {
	if ( this._activeEditorTab !== undefined ) {
		delete this._activeEditorTab.tabsContainer.dataset.mceSelected;
	}
	editorTab.tabsContainer.dataset.mceSelected = '1';
	this._activeEditorTab = editorTab;
	console.log(this._activeEditorTab);
};

EditorsTabs.prototype.addEventSelect = function () {
	this._activeEditorTab.tabsContainer.addEventListener( 'click', this.setActiveEditorTab.bind(this, this._activeEditorTab) );
};

tinymce.PluginManager.add('myplugin', function(editor, url) {
	var editorsTabs = new EditorsTabs();
	// Adds a menu item to the tools menu
	editor.addMenuItem('myplugin', {
		text: 'myplugin plugin',
		context: 'tools',
		onclick: function() {
			// Open window with a specific url
			editor.windowManager.open({
				title: 'myplugin plugin',
				body: [
					{type: 'textbox', name: 'title', label: 'Title'}
				],
				onsubmit: function(e) {
					var editorTabs = new EditorTabs(editor);
					
					editorTabs.setTabsContainer( [ { title: e.data.title } ] );
					editorsTabs.addEditorTab(editorTabs);
					// Insert content when the window form is submitted

/* 					var tabsContainer = createTabs([ { title: e.data.title } ]);
					
					editor.selection.setNode(tabsContainer);
					var tabs = new Tabs(editor.dom.get('tabsContainer'));			 */		
				}
			});
		}
	});
});